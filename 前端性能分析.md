## 前端性能分析

------

> 本周数据报表， <font style="color: red">错误</font> 是由于统计了二次渲染的时间导致值过大，首屏pagecomplete过长，现已修复。

<table>
   <caption>Qunar App</caption>
   <tr bgcolor='#f1f1f1' style="text-align:left">
        <th width=10%>95线报表</th>
        <th width=10%>用户可交互耗时95线
        pagecomplete</th>
        <th width=10%>用户可交互耗时
        pagecomplete</th>
        <th width=20%>首次渲染完毕耗时（前端渲染耗时）pageshow</th>
        <th width=10%>前端渲染耗时目标</th>
        <th width=10%>服务耗时
        soaserver</th>
        <th width=10%>网络耗时
        soatotal</th>
        <th width=10%>首次内容绘制耗时
        fcp</th>
        <th width=10%>首次有意义绘制耗时
        fmp</th>
   </tr>
   <tr>
        <td >首页</td>
        <td>5721</td>
        <td>5003</td>
        <td>4819</td>
        <td>3500</td>
        <td>null</td>
        <td>0</td>
        <td>71</td>
        <td>1043</td>
   </tr>
   <tr>
        <td >列表页</td>
        <td style="color: red">错误</td>
        <td style="color: red">错误</td>
        <td>3057</td>
        <td>2000</td>
        <td>457</td>
        <td>1439</td>
        <td>621</td>
        <td>1291</td>
   </tr>
   <tr>
        <td >填写页</td>
        <td style="color: red">错误</td>
        <td style="color: red">错误</td>
        <td>3889</td>
        <td>1000</td>
        <td>null</td>
        <td>1756</td>
        <td>570</td>
        <td>1047</td>
    </tr>
    <tr bgcolor='#f1f1f1' style="text-align:left">
        <th width=10%>80线报表</th>
        <th width=10%>用户可交互耗时95线
        pagecomplete</th>
        <th width=10%>用户可交互耗时
        pagecomplete</th>
        <th width=10%>首次渲染完毕耗时（前端渲染耗时）pageshow</th>
        <th width=10%>前端渲染耗时目标</th>
        <th width=10%>服务耗时
        soaserver</th>
        <th width=10%>网络耗时
        soatotal</th>
        <th width=10%>首次内容绘制耗时
        fcp</th>
        <th width=10%>首次有意义绘制耗时
        fmp</th>
    </tr>
    <tr>
        <td>首页</td>
        <td>2552</td>
        <td>2608</td>
        <td>2508</td>
        <td>2000</td>
        <td>null</td>
        <td>0</td>
        <td>67</td>
        <td>1268</td>
   </tr>
   <tr>
        <td>列表页</td>
        <td>8342</td>
        <td>2705</td>
        <td>1850</td>
        <td>1000</td>
        <td>189</td>
        <td>808</td>
        <td>831</td>
        <td>871</td>
   </tr>
   <tr>
        <td>填写页</td>
        <td>2745</td>
        <td>2376</td>
        <td>2341</td>
        <td>800</td>
        <td>null</td>
        <td>981</td>
        <td>395</td>
        <td>495</td>
   </tr>
</table>

<table>
   <caption>Ctrip H5</caption>
   <tr bgcolor='#f1f1f1' style="text-align:left">
        <th width=10%>95线报表</th>
        <th width=10%>用户可交互耗时95线
        pagecomplete</th>
        <th width=10%>用户可交互耗时
        pagecomplete</th>
        <th width=20%>首次渲染完毕耗时（前端渲染耗时）pageshow</th>
        <th width=10%>前端渲染耗时目标</th>
        <th width=10%>服务耗时
        soaserver</th>
        <th width=10%>网络耗时
        soatotal</th>
        <th width=10%>首次内容绘制耗时
        fcp</th>
        <th width=10%>首次有意义绘制耗时
        fmp</th>
   </tr>
   <tr>
        <td >首页</td>
        <td>6431</td>
        <td>6431</td>
        <td>6351</td>
        <td>3500</td>
        <td>null</td>
        <td>0</td>
        <td>77</td>
        <td>898</td>
   </tr>
   <tr>
        <td >列表页</td>
        <td style="color: red">错误</td>
        <td style="color: red">错误</td>
        <td>706</td>
        <td>500</td>
        <td>324</td>
        <td>717</td>
        <td>null</td>
        <td>null</td>
   </tr>
   <tr>
        <td >填写页</td>
        <td style="color: red">错误</td>
        <td style="color: red">错误</td>
        <td>736</td>
        <td>500</td>
        <td>324</td>
        <td>717</td>
        <td>null</td>
        <td>null</td>
    </tr>
    <tr bgcolor='#f1f1f1' style="text-align:left">
        <th width=10%>80线报表</th>
        <th width=10%>用户可交互耗时95线
        pagecomplete</th>
        <th width=10%>用户可交互耗时
        pagecomplete</th>
        <th width=10%>首次渲染完毕耗时（前端渲染耗时）pageshow</th>
        <th width=10%>前端渲染耗时目标</th>
        <th width=10%>服务耗时
        soaserver</th>
        <th width=10%>网络耗时
        soatotal</th>
        <th width=10%>首次内容绘制耗时
        fcp</th>
        <th width=10%>首次有意义绘制耗时
        fmp</th>
    </tr>
    <tr>
        <td>首页</td>
        <td>3338</td>
        <td>3299</td>
        <td>3277</td>
        <td>2000</td>
        <td>null</td>
        <td>0</td>
        <td>68</td>
        <td>645</td>
   </tr>
   <tr>
        <td>列表页</td>
        <td>2593</td>
        <td>1719</td>
        <td>407</td>
        <td>300</td>
        <td>1014</td>
        <td>1306</td>
        <td>null</td>
        <td>null</td>
   </tr>
   <tr>
        <td>填写页</td>
        <td>2365</td>
        <td>2193</td>
        <td>727</td>
        <td>300</td>
        <td>null</td>
        <td>1463</td>
        <td>null</td>
        <td>null</td>
   </tr>
</table>



### 和机票h5对比

#### 国内租车
![国内租车](https://ws1.sinaimg.cn/large/006tNc79ly1fzisbeaxy3j30u0102dtv.jpg)

#### 机票
![机票](https://ws1.sinaimg.cn/large/006tNc79ly1fzisnxve9uj30u010v15h.jpg)

通过比较，`fcp`和`fmp`数据较好，即首屏速度还是较快的。问题在于`speed index`和`time to interactive`表现较差，即后续资源加载较慢，基本可以判断是静态资源加载的阻塞。

所以，我们来看下资源加载情况。
![view trace](https://ws3.sinaimg.cn/large/006tNc79gy1fzisuxqv0vj318j0u0kdm.jpg)
可以看到一个js，加载了**2.03秒**，这个脚本是vendor, 各种依赖库的打包，压缩后依然有**567k**，所以问题的关键就在于减小这个脚本的大小。
分析一下这个脚本的组成,目前大头在这两个
1. pdfjs
![pdfjs](https://ws3.sinaimg.cn/large/006tNc79gy1fzitvqfap3j30xl0u0dld.jpg)
2. swiperjs
![swiper](https://ws2.sinaimg.cn/large/006tNc79gy1fzitvtnuzyj30wj0u0jwp.jpg)

> 处理方案： pdfjs会从vendor中拆出，按需加载。swiperjs采用轻量的替换，并按需加载，从vendor中拆出。



### 进一步优化

- [ ] **资源预加载** [参考](https://medium.com/reloading/preload-prefetch-and-priorities-in-chrome-776165961bbf)
    - [ ] dns预解析
    - [ ] preload
    - [ ] prefetch 

- [ ] **减小js大小**
    - [ ] Tree Shaking [参考](https://developers.google.com/web/fundamentals/performance/optimizing-javascript/tree-shaking/)
    - [ ] Code Splitting [参考](https://developers.google.com/web/fundamentals/performance/optimizing-javascript/code-splitting/)

- [ ] **webpack 优化** [参考](https://developers.google.com/web/fundamentals/performance/webpack/)
    - [ ] 减小资源大小 [参考](https://developers.google.com/web/fundamentals/performance/webpack/decrease-frontend-size)
    - [ ] 使用长效缓存 [参考](https://developers.google.com/web/fundamentals/performance/webpack/use-long-term-caching)
    - [ ] 监控 [参考](https://developers.google.com/web/fundamentals/performance/webpack/monitor-and-analyze)

- [ ] **PRPL 模式** [参考](https://developers.google.com/web/fundamentals/performance/prpl-pattern/)
    - [ ] 推送 - 为初始网址路由推送关键资源。
    - [ ] 渲染 - 渲染初始路由。
    - [ ] 延迟 - 预缓存剩余路由。
    - [ ] 预加载 - 延迟加载并按需创建剩余路由。
